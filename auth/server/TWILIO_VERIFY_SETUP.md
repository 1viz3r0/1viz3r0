# Twilio Verify API Setup Guide

## Overview

Your application now uses **Twilio Verify API** instead of regular SMS for sending and verifying OTP codes. This provides better security, automatic rate limiting, and code expiration management.

## What Changed?

### Before (Regular SMS)
- You generated OTP codes manually
- You stored OTP codes in database
- You managed expiration and attempts manually

### After (Twilio Verify)
- Twilio generates OTP codes automatically
- Twilio manages code expiration (default: 10 minutes)
- Twilio handles rate limiting and attempts
- More secure and reliable

## Configuration

### Step 1: Add Verify Service SID to .env

Add this line to your `server/.env` file:

```env
# Twilio Verify Configuration
TWILIO_VERIFY_SERVICE_SID=YOUR_TWILIO_VERIFY_SERVICE_SID
```

### Step 2: Complete .env File

Your Twilio section should look like this:

```env
# Twilio Configuration
TWILIO_ACCOUNT_SID=YOUR_TWILIO_ACCOUNT_SID
TWILIO_AUTH_TOKEN=YOUR_TWILIO_AUTH_TOKEN
TWILIO_VERIFY_SERVICE_SID=YOUR_TWILIO_VERIFY_SERVICE_SID
TWILIO_PHONE_NUMBER=+917702450488  # Optional, not used with Verify API
```

### Step 3: Restart Server

After updating `.env`, restart your server:
```bash
npm start
# or
node server.js
```

## How It Works

### 1. Sending OTP

When a user registers, the system:
1. Calls Twilio Verify API with the phone number
2. Twilio generates and sends a 6-digit code
3. Code is valid for 10 minutes (default)
4. User receives SMS with the code

### 2. Verifying OTP

When user enters the code:
1. System calls Twilio Verify API with phone number and code
2. Twilio checks if the code is valid
3. Returns success/failure status
4. System proceeds based on verification result

## API Changes

### Send OTP (SMS)
```javascript
// Before
await sendOTPSMS(phone, otp);

// After  
await sendOTPSMS(phone); // OTP is generated by Twilio
```

### Verify OTP (SMS)
```javascript
// Before
const verification = verifyOTP(session.mobileOTP.code, otp, expiresAt);

// After
const twilioVerification = await verifyOTPSMS(phone, otp);
if (twilioVerification.valid) {
  // Code is valid
}
```

## Benefits

✅ **Better Security**: Codes are managed by Twilio, not stored in your database  
✅ **Automatic Expiration**: Codes expire after 10 minutes automatically  
✅ **Rate Limiting**: Twilio prevents abuse automatically  
✅ **Better Delivery**: Higher SMS delivery rates  
✅ **Compliance**: Meets security standards for verification  

## Phone Number Format

**Important**: Phone numbers must be in **E.164 format**:
- ✅ Correct: `+917702450488`, `+1234567890`
- ❌ Wrong: `917702450488`, `+1 (234) 567-8900`

The phone number must include:
- `+` prefix
- Country code
- Phone number without spaces or special characters

## Testing

### Test Sending OTP
1. Register a new account
2. Check your phone for SMS from Twilio
3. Code will be 6 digits
4. Valid for 10 minutes

### Test Verifying OTP
1. Enter the code you received
2. System verifies with Twilio
3. If valid, registration completes
4. If invalid, error message shown

## Troubleshooting

### Error: "Invalid phone number format"
**Solution**: Make sure phone number is in E.164 format (`+` followed by country code and number)

### Error: "Max send attempts reached"
**Solution**: Twilio limits how many codes can be sent. Wait a few minutes and try again.

### Error: "Verification code expired"
**Solution**: Codes expire after 10 minutes. Request a new code.

### Error: "Too many verification attempts"
**Solution**: Too many failed attempts. Request a new code.

### Code Not Received
1. Check phone number format
2. Check spam folder
3. Verify Twilio account has credits
4. Check Twilio console for delivery status

## Twilio Console

You can monitor verifications in Twilio Console:
1. Go to: https://console.twilio.com/
2. Navigate to: Verify → Services → Your Service
3. View verification attempts and status

## Migration Notes

- **Email OTP**: Still uses your custom implementation (no change)
- **SMS OTP**: Now uses Twilio Verify API
- **Session Storage**: SMS OTP is no longer stored in session (managed by Twilio)
- **Verification**: Uses Twilio API instead of custom verification

## Code Changes Summary

### Updated Files
1. `server/utils/sms.js` - Added Twilio Verify API integration
2. `server/routes/auth.js` - Updated to use Twilio Verify for SMS

### New Functions
- `sendOTPSMS(phone)` - Sends OTP via Twilio Verify
- `verifyOTPSMS(phone, code)` - Verifies OTP via Twilio Verify

### Removed
- Manual OTP generation for SMS (now handled by Twilio)
- OTP storage in session for SMS (now managed by Twilio)

## Need Help?

- **Twilio Docs**: https://www.twilio.com/docs/verify
- **Twilio Console**: https://console.twilio.com/
- **Support**: Check server console for detailed error messages

